resolver 127.0.0.11 valid=10s;

server {
    listen 80;
    server_name _;

    client_max_body_size 50M;

    set $frontend_upstream http://frontend:3000;
    set $ctg_upstream http://ctg-monitor:8000;
    set $apgar_upstream http://apgar-transition:8001;
    set $symbolic_upstream http://symbolic-reasoning:8002;
    set $polygraph_upstream http://polygraph-verifier:8003;
    set $bishop_upstream http://bishop-partogram:8004;
    set $rciu_upstream http://rciu-risk:8005;
    set $quantum_upstream http://quantum-optimizer:8006;
    set $motherbaby_upstream http://mother-baby-risk:8007;
    set $narrative_upstream http://clinical-narrative:8008;
    set $engagement_upstream http://user-engagement:8009;
    set $prenatal_upstream http://prenatal-followup:8010;

    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";

    # Frontend (catch-all + Next.js API routes including /api/agents/health)
    location / {
        proxy_pass $frontend_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/ {
        proxy_pass $frontend_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Agent endpoints (proxied to Docker-internal services)
    location /api/ctg-monitor {
        proxy_pass $ctg_upstream/api/ctg-monitor;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /api/apgar-transition {
        proxy_pass $apgar_upstream/api/apgar-transition;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /api/apgar {
        proxy_pass $apgar_upstream/api/apgar-transition;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /api/symbolic-reasoning {
        proxy_pass $symbolic_upstream/api/symbolic-reasoning;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /api/polygraph {
        proxy_pass $polygraph_upstream/api/polygraph;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /api/bishop-partogram {
        proxy_pass $bishop_upstream/api/bishop-partogram;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /api/rciu-risk {
        proxy_pass $rciu_upstream/api/rciu-risk;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /api/quantum-optimizer {
        proxy_pass $quantum_upstream/api/quantum-optimizer;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /api/mother-baby-risk {
        proxy_pass $motherbaby_upstream/api/mother-baby-risk;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /api/clinical-narrative {
        proxy_pass $narrative_upstream/api/clinical-narrative;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /api/user-engagement {
        proxy_pass $engagement_upstream/api/user-engagement;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /api/prenatal-followup {
        proxy_pass $prenatal_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}

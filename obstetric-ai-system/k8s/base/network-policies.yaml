# Network Policies: deny-all by default, allow explicit traffic
# Zero-trust: no pod can receive or send traffic unless allowed

---
# Default deny all ingress in obs-prod
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-ingress
  namespace: obs-prod
spec:
  podSelector: {}
  policyTypes:
    - Ingress
---
# Default deny all egress in obs-prod (optional: relax for DNS/external APIs)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-egress
  namespace: obs-prod
spec:
  podSelector: {}
  policyTypes:
    - Egress
---
# Allow DNS and same-namespace egress for obs-prod
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-internal-egress
  namespace: obs-prod
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
    - to:
        - podSelector: {}
      ports:
        - protocol: TCP
          port: 5432
        - protocol: TCP
          port: 6379
        - protocol: TCP
          port: 9000
---
# Allow ingress to PostgreSQL only from obs-fhir and agents in obs-prod
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-postgres-ingress
  namespace: obs-prod
spec:
  podSelector:
    matchLabels:
      app: postgresql
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: obs-fhir
      ports:
        - protocol: TCP
          port: 5432
    - from:
        - podSelector:
            matchLabels:
              app: postgresql
      ports:
        - protocol: TCP
          port: 5432
---
# obs-fhir: deny all ingress by default
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-ingress
  namespace: obs-fhir
spec:
  podSelector: {}
  policyTypes:
    - Ingress
---
# obs-fhir: allow ingress from ingress controller (adjust selector as needed)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-ingress-controller
  namespace: obs-fhir
spec:
  podSelector:
    matchLabels:
      app: hapi-fhir
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: ingress-nginx
      ports:
        - protocol: TCP
          port: 8080
---
# obs-ml: deny all ingress
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-ingress
  namespace: obs-ml
spec:
  podSelector: {}
  policyTypes:
    - Ingress
---
# obs-staging: deny all ingress
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-ingress
  namespace: obs-staging
spec:
  podSelector: {}
  policyTypes:
    - Ingress
